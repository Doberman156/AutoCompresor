name: ðŸš€ Crear Release AutomÃ¡tico

# Se ejecuta cuando se crea un nuevo tag que empiece con 'v'
on:
  push:
    tags:
      - 'v*'

# Permisos necesarios para crear releases
permissions:
  contents: write
  actions: read

jobs:
  create-release:
    name: ðŸ“¦ Crear Release
    runs-on: windows-latest
    
    steps:
    # 1. Checkout del cÃ³digo
    - name: ðŸ“¥ Descargar cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. Configurar Python
    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # 3. Instalar dependencias
    - name: ðŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    # 4. Compilar aplicaciÃ³n
    - name: ðŸ”¨ Compilar aplicaciÃ³n
      run: |
        python build.py
    
    # 5. Verificar que el ejecutable existe
    - name: âœ… Verificar ejecutable
      run: |
        if (Test-Path "dist\AutomatizacionCompresion.exe") {
          Write-Host "âœ… Ejecutable creado correctamente"
          $size = (Get-Item "dist\AutomatizacionCompresion.exe").Length / 1MB
          Write-Host "ðŸ“ TamaÃ±o: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ Error: No se encontrÃ³ el ejecutable"
          exit 1
        }
    
    # 6. Obtener informaciÃ³n de la versiÃ³n
    - name: ðŸ“‹ Obtener informaciÃ³n de versiÃ³n
      id: version
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        
        # Leer informaciÃ³n adicional de version.json si existe
        if (Test-Path "version.json") {
          $versionData = Get-Content "version.json" | ConvertFrom-Json
          $releaseNotes = $versionData.release_notes
          $buildDate = $versionData.build_date
          echo "release_notes=$releaseNotes" >> $env:GITHUB_OUTPUT
          echo "build_date=$buildDate" >> $env:GITHUB_OUTPUT
        } else {
          echo "release_notes=Nueva versiÃ³n con mejoras y correcciones" >> $env:GITHUB_OUTPUT
          echo "build_date=$(Get-Date -Format 'yyyy-MM-dd')" >> $env:GITHUB_OUTPUT
        }
    
    # 7. Crear archivo ZIP con el ejecutable
    - name: ðŸ“¦ Crear archivo ZIP
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $zipName = "AutomatizacionCompresion-v$version-Windows.zip"
        
        # Crear carpeta temporal
        New-Item -ItemType Directory -Path "release-temp" -Force
        
        # Copiar ejecutable
        Copy-Item "dist\AutomatizacionCompresion.exe" "release-temp\"
        
        # Copiar archivos adicionales si existen
        if (Test-Path "README.md") {
          Copy-Item "README.md" "release-temp\"
        }
        if (Test-Path "LICENCIA.txt") {
          Copy-Item "LICENCIA.txt" "release-temp\"
        }
        if (Test-Path "CHANGELOG.md") {
          Copy-Item "CHANGELOG.md" "release-temp\"
        }
        
        # Crear archivo de instrucciones
        @"
        ðŸš€ AutomatizaciÃ³n de CompresiÃ³n de Archivos v$version
        
        ðŸ“‹ INSTRUCCIONES DE INSTALACIÃ“N:
        
        1. Extrae todos los archivos de este ZIP
        2. Ejecuta AutomatizacionCompresion.exe
        3. La aplicaciÃ³n se iniciarÃ¡ automÃ¡ticamente
        
        ðŸ“ CARACTERÃSTICAS:
        â€¢ CompresiÃ³n automÃ¡tica de archivos
        â€¢ MÃºltiples formatos soportados
        â€¢ Interfaz grÃ¡fica intuitiva
        â€¢ Sistema de actualizaciones automÃ¡ticas
        â€¢ GestiÃ³n de perfiles de configuraciÃ³n
        
        ðŸ”„ ACTUALIZACIONES:
        La aplicaciÃ³n verificarÃ¡ automÃ¡ticamente si hay nuevas versiones disponibles.
        
        ðŸ“ž SOPORTE:
        Si encuentras algÃºn problema, reporta un issue en:
        https://github.com/TU-USUARIO/automatizacion-compresion/issues
        
        ðŸ“… Fecha de compilaciÃ³n: ${{ steps.version.outputs.build_date }}
        "@ | Out-File -FilePath "release-temp\LEEME.txt" -Encoding UTF8
        
        # Crear ZIP
        Compress-Archive -Path "release-temp\*" -DestinationPath $zipName -Force
        
        # Verificar ZIP
        if (Test-Path $zipName) {
          $zipSize = (Get-Item $zipName).Length / 1MB
          Write-Host "âœ… ZIP creado: $zipName ($([math]::Round($zipSize, 2)) MB)"
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "âŒ Error al crear ZIP"
          exit 1
        }
    
    # 8. Generar notas del release
    - name: ðŸ“ Generar notas del release
      id: release_notes
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $buildDate = "${{ steps.version.outputs.build_date }}"
        
        $releaseNotes = @"
        ## ðŸš€ AutomatizaciÃ³n de CompresiÃ³n v$version
        
        ### ðŸ“… InformaciÃ³n de la versiÃ³n
        - **VersiÃ³n:** $version
        - **Fecha de compilaciÃ³n:** $buildDate
        - **Plataforma:** Windows (x64)
        
        ### ðŸ“¦ Archivos incluidos
        - `AutomatizacionCompresion.exe` - AplicaciÃ³n principal
        - `LEEME.txt` - Instrucciones de instalaciÃ³n
        
        ### âœ¨ CaracterÃ­sticas principales
        - ðŸ—œï¸ CompresiÃ³n automÃ¡tica de archivos
        - ðŸ“ Soporte para mÃºltiples formatos
        - ðŸŽ¨ Interfaz grÃ¡fica moderna e intuitiva
        - ðŸ”„ Sistema de actualizaciones automÃ¡ticas
        - âš™ï¸ GestiÃ³n avanzada de perfiles
        - ðŸ“Š EstadÃ­sticas detalladas de procesamiento
        - ðŸ›¡ï¸ ValidaciÃ³n y respaldo automÃ¡tico
        
        ### ðŸ”„ Actualizaciones automÃ¡ticas
        Esta versiÃ³n incluye un sistema de actualizaciones automÃ¡ticas que verificarÃ¡ periÃ³dicamente si hay nuevas versiones disponibles.
        
        ### ðŸ“¥ InstalaciÃ³n
        1. Descarga el archivo ZIP
        2. Extrae todos los archivos
        3. Ejecuta `AutomatizacionCompresion.exe`
        
        ### ðŸ› Reportar problemas
        Si encuentras algÃºn error, por favor reporta un issue en el repositorio.
        
        ---
        
        **Nota:** Esta aplicaciÃ³n es completamente portable y no requiere instalaciÃ³n adicional.
        "@
        
        # Guardar en archivo temporal
        $releaseNotes | Out-File -FilePath "release-notes.md" -Encoding UTF8
        
        # TambiÃ©n guardar en variable de salida (escapando caracteres especiales)
        $escapedNotes = $releaseNotes -replace '`', '\`' -replace '"', '\"' -replace '\r?\n', '\n'
        echo "notes=$escapedNotes" >> $env:GITHUB_OUTPUT
    
    # 9. Crear el release en GitHub
    - name: ðŸŽ‰ Crear Release en GitHub
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: "ðŸš€ AutomatizaciÃ³n de CompresiÃ³n v${{ steps.version.outputs.version }}"
        body_path: release-notes.md
        files: |
          ${{ steps.version.outputs.zip_name }}
          dist/AutomatizacionCompresion.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 10. NotificaciÃ³n de Ã©xito
    - name: âœ… Release completado
      run: |
        Write-Host "ðŸŽ‰ Release v${{ steps.version.outputs.version }} creado exitosamente!"
        Write-Host "ðŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
        Write-Host "ðŸ“¦ Archivos incluidos:"
        Write-Host "   - ${{ steps.version.outputs.zip_name }}"
        Write-Host "   - AutomatizacionCompresion.exe"
        Write-Host ""
        Write-Host "ðŸ“¢ Los usuarios ahora pueden descargar la nueva versiÃ³n!"